---
title: "exploratory_crash_worksheet"
author: "Conor Tompkins"
date: "4/21/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE)

getwd()
```

```{r}
library(tidyverse)
library(skimr)
library(janitor)
library(lubridate)
library(viridis)
library(ggmap)
library(broom)
library(ggraph)
library(igraph)
library(corrr)

theme_set(theme_bw(base_size = 18))

options(scipen = 999, digits = 4)
```



```{r}
source("scripts/02_factorize_columns.R")
source("scripts/03_clean_data.R")

df <- data
rm("data", "df_combined_allegheny_county_crash_data_2004_2017_factorized")

df %>% 
  filter(crash_year == 2015) %>% 
  count(crash_year, crash_month, day_of_week, day_of_week_old) -> test
```

```{r}
df %>% 
  count(crash_year, crash_month) %>%
  mutate(time_period = str_c(crash_year, crash_month, sep = "-"),
         time_period = fct_inorder(time_period)) %>% 
  ggplot(aes(crash_month, n, color = as.factor(crash_year), group = crash_year)) +
    geom_line()
```
```{r}
df %>% 
  count(crash_year, day_of_week) %>% 
  ggplot(aes(day_of_week, n)) +
    geom_col() +
    facet_wrap(~crash_year, ncol = 1)
```


```{r}
df %>% 
  count(crash_year, crash_month, day_of_week) %>%
  mutate(time_period = str_c(crash_year, crash_month, day_of_week, sep = "-"),
         time_period = fct_inorder(time_period)) %>% 
  ggplot(aes(time_period, n, group = 1)) +
    geom_jitter(alpha = .1) +
    geom_smooth() +
  labs(x = "Year-Month-Weekday") +
  theme(axis.text.x = element_blank())
```

```{r}
df %>% 
  count(crash_year, crash_month, day_of_week, hour_of_day) %>%
  mutate(time_period = str_c(crash_year, crash_month, day_of_week, hour_of_day, sep = "-"),
         time_period = fct_inorder(time_period)) %>% 
  ggplot(aes(time_period, n, group = 1)) +
    geom_jitter(alpha = .01) +
    geom_smooth() +
  labs(x = "Year-Month-Weekday-Hour") +
  theme(axis.text.x = element_blank())
```

```{r}
df %>% 
  mutate(crash_month = fct_rev(crash_month)) %>% 
  count(crash_year, crash_month) %>% 
  ggplot(aes(crash_year, crash_month, fill = n)) +
    geom_tile() +
    coord_equal() +
    scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(expand = c(0,0)) +
    scale_fill_viridis() +
    theme(panel.grid = element_blank())
```

```{r}
df %>% 
  mutate(day_of_week = fct_rev(day_of_week)) %>% 
  filter(!hour_of_day > 24,
         !is.na(day_of_week)) %>% 
  count(day_of_week, hour_of_day) %>% 
  ggplot(aes(hour_of_day, day_of_week, fill = n)) +
  geom_tile() +
  coord_equal() +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_fill_viridis()
```

```{r}
df %>% 
  filter(!time_of_day > 2400,
         !is.na(day_of_week)) %>% 
  ggplot(aes(time_of_day, color = day_of_week)) +
  geom_freqpoly(size = 2) +
  scale_color_viridis(discrete = TRUE)
```

```{r}
df %>% 
  count(speed_limit) %>% 
  ggplot(aes(speed_limit, n)) +
  geom_col()
```

```{r}
df %>%
  count(speed_limit, speeding_related) %>% 
  ggplot(aes(speed_limit, n, color = speeding_related)) +
  geom_point()
```

```{r}
df$day_of_week %>% 
  levels()
df %>%
  mutate(day_of_week = fct_rev(day_of_week)) %>% 
  filter(hour_of_day < 24) %>% 
  group_by(day_of_week, hour_of_day) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>% 
  ggplot(aes(hour_of_day, day_of_week, fill = fatalities_per_person)) +
  geom_tile() +
  coord_equal() +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_fill_viridis()
```

```{r}
df %>%
  complete(road_condition, weather) %>% 
  group_by(road_condition, weather) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>% 

  ggplot(aes(road_condition, weather, fill = fatalities_per_person, alpha = person_sum)) +
  geom_tile() +
  coord_equal() +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_fill_viridis() +
  theme(panel.grid = element_blank())
```


```{r}
df %>% 
  group_by(weather) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>% 
  ggplot(aes(person_sum, fatal_sum, label = weather)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```
```{r}
df %>% 
  group_by(illumination) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>% 
  ggplot(aes(person_sum, fatal_sum, label = illumination)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```
```{r}
df %>% 
  group_by(road_condition) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>%
  ggplot(aes(person_sum, fatal_sum, label = road_condition)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```

```{r}
df %>% 
  group_by(road_owner) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>%
  ggplot(aes(person_sum, fatal_sum, label = road_owner)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```

```{r}
df %>% 
  group_by(relation_to_road) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>%
  ggplot(aes(person_sum, fatal_sum, label = relation_to_road)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```

```{r}
df %>% 
  group_by(tcd_type) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>%
  ggplot(aes(person_sum, fatal_sum, label = tcd_type)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```

```{r}
df %>% 
  group_by(collision_type) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>%
  ggplot(aes(person_sum, fatal_sum, label = collision_type)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```

```{r}
df %>% 
  group_by(location_type) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>%
  ggplot(aes(person_sum, fatal_sum, label = location_type)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE)
```

```{r}
df %>% 
  select(illumination, weather, road_condition, road_owner, collision_type, relation_to_road, intersect_type, tcd_type, tcd_func_cd, location_type, rdwy_surf_type_cd, rdwy_orient, work_zone_type, work_zone_loc, person_count, fatal_count) %>% 
  gather(metadata_measure, metadata_value, -c(person_count, fatal_count)) %>% 
  group_by(metadata_measure, metadata_value) %>% 
  summarize(person_sum = sum(person_count, na.rm = TRUE),
            fatal_sum = sum(fatal_count, na.rm = TRUE),
            fatalities_per_person = fatal_sum / person_sum) %>%
  ggplot(aes(person_sum, fatal_sum, label = metadata_value)) +
  geom_label() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~metadata_measure)
```














#working on networking
```{r}
set.seed(1234)

df %>% 
  select(weather, road_condition) %>%
  mutate_all(as.character) %>% 
  count(weather, road_condition) %>% 
  replace_na(list(weather = "Missing", road_condition = "Missing")) %>% 
  arrange(desc(n)) %>% 
  graph_from_data_frame(directed = FALSE) %>% 
  ggraph() + 
    geom_edge_link(aes(edge_alpha = n)) + 
    geom_node_label(aes(label = name)) +
  theme_bw()

df %>% 
  select(crash_year, crash_month, day_of_week, hour_of_day, weather, road_condition) %>%
  mutate_all(as.character) %>% 
  count(crash_year, crash_month, day_of_week, hour_of_day, weather, road_condition) %>% 
  replace_na(list(weather = "Missing", road_condition = "Missing")) %>% 
  gather(environmental_measure, value, -c(crash_year, crash_month, day_of_week, hour_of_day, n)) %>% 
  mutate(value = str_c(environmental_measure, value, sep = "-")) %>% 
  group_by(crash_year, crash_month, day_of_week, hour_of_day, value) %>% 
  summarize(n = sum(n)) %>% 
  spread(value, n) %>% 
  ungroup() %>% 
  select(-c(crash_year, crash_month, day_of_week, hour_of_day)) %>% 
  correlate() %>% 
  stretch() %>%
  filter(!is.na(r),
         abs(r) > .3) -> df_graph

df_graph %>% 
  graph_from_data_frame(directed = FALSE) %>% 
  ggraph() + 
    geom_edge_link(aes(edge_width = abs(r), color = r)) + 
    #scale_edge_color_viridis()
    geom_node_label(aes(label = name)) +
    scale_edge_width_continuous(range = c(.1, 2)) +
    scale_edge_alpha(range = c(.1, 1))
  
```